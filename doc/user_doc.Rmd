---
title: "16S Visualization Pipeline"
output:
  html_document:
    smart: false  
    mathjax: null
    section_divs: false
    highlight: tango
    theme: null
    template: /Users/subramanianp4/git/nephele2/misc_examples/Rdocs/user_guide_template.html
    toc: true
    toc_depth: 2
  md_document:
    variant: markdown_github-ascii_identifiers+link_attributes
    toc: true
    toc_depth: 2
---

```{r setup, include=FALSE}
#knitr::opts_chunk$set(echo = TRUE, eval = FALSE, tidy=FALSE)
knitr::opts_chunk$set(echo = TRUE, eval = FALSE, tidy=TRUE)
```

## ampvis2 and Plotly
Nephele uses the [ampvis2 R package](https://madsalbertsen.github.io/ampvis2/){target="_blank" rel="noopener noreferrer"} v2.3.2 for statistical computation.  We also make use of the [Plotly R interface](https://plot.ly/r/){target="_blank" rel="noopener noreferrer"} for the [plotly.js](https://plot.ly){target="_blank" rel="noopener noreferrer"} charting library.  The plots can be minimally edited interactively.  However, they also have a link to export the data to the [Plotly Chart Studio](https://plot.ly/online-chart-maker/){target="_blank" rel="noopener noreferrer"} which allows for [making a variety of charts](https://help.plot.ly/tutorials/){target="_blank" rel="noopener noreferrer"}.  We have a tutorial for <a href="{{ url_for('show_tutorials') }}">making simple edits to the plots here</a>.

## Plots
### Rarefaction Curve
The rarefaction curves are made with the [amp_rarecurve](https://madsalbertsen.github.io/ampvis2/reference/amp_rarecurve.html){target="_blank" rel="noopener noreferrer"} function.  The table is written to *rarecurve.txt* and the plot to *rarecurve.html*.
```{r}
rarecurve <- amp_rarecurve(amp, color_by = "TreatmentGroup")
```

### PCoA
Principal coordinates analysis using binomial and Bray-Curtis distances is carried out using [amp_ordinate](https://madsalbertsen.github.io/ampvis2/reference/amp_ordinate.html){target="_blank" rel="noopener noreferrer"}.  Samples which fall below the specified sampling depth are removed from the OTU table using [amp_subset_samples](https://madsalbertsen.github.io/ampvis2/reference/amp_subset_samples.html){target="_blank" rel="noopener noreferrer"} before the distance measures are computed.  The names of samples that are removed are output to *samples_being_ignored.txt*. 

The binomial distance is able to handle varying sample sizes.  However, for the Bray-Curtis distance, the OTU table is rarefied to the sampling depth using [rrarefy](https://www.rdocumentation.org/packages/vegan/versions/2.4-2/topics/rarefy){target="_blank" rel="noopener noreferrer"} from the vegan R package.  At least 3 samples are needed in the OTU table for the plot to be generated.  The tables are written to *pcoa_binomial.txt* and *pcoa_bray.txt* and the plots to *pcoa_binomial.html* and *pcoa_bray.html*.
```{r, tidy.opts=list(width.cutoff=60)}
amp <- amp_subset_samples(amp, minreads = sampdepth)
pcoa_binomial <- amp_ordinate(amp,filter_species = 0.01, type="PCOA", distmeasure = "binomial", sample_color_by = "TreatmentGroup", detailed_output = TRUE, transform="none")
otu <- rrarefy(t(amp$abund), sampdepth)
amp$abund <- t(otu)
pcoa_bray <- amp_ordinate(amp,filter_species = 0.01, type="PCOA", distmeasure = "bray", sample_color_by = "TreatmentGroup", detailed_output = TRUE, transform="none")
```

### Alpha diversity
The Shannon diversity and Chao species richness are computed using [amp_alphadiv](https://madsalbertsen.github.io/ampvis2/reference/amp_alphadiv.html){target="_blank" rel="noopener noreferrer"}. Samples which fall below the specified sampling depth are removed, and the OTU table is rarefied to the sampling depth before the diversity computation.  The table is written to *alphadiv.txt*, and boxplots are output to *alphadiv.html*.  At least 3 samples are needed to produce these plots.

```{r}
alphadiv <- amp_alphadiv(amp, measure="shannon", richness = TRUE, rarefy = sampdepth)
```

### Heatmap
The interactive heatmap is implemented using the [morpheus R API](https://github.com/cmap/morpheus.R){target="_blank" rel="noopener noreferrer"} developed at the Broad Institute.  [Documentation](https://software.broadinstitute.org/morpheus/documentation.html){target="_blank" rel="noopener noreferrer"} for how to use the heatmap can be found on the [morpheus website](https://software.broadinstitute.org/morpheus/){target="_blank" rel="noopener noreferrer"}.

The OTU table is first normalized to represent the relative abundances using amp_subset_samples before the heatmap is made with morpheus.  In order for the heatmap to be generated, the OTU table must be at least 2x2.  The heatmap is made from the raw OTU table (*seq_heatmap.html*).
```{r,  tidy.opts=list(width.cutoff=50)}
amptax <- amp_subset_samples(amp, normalise = TRUE)
heatmap <- morpheus(amp$abund, columns=columns, rows = rows, columnColorModel = list(type=as.list(colors)), colorScheme = list(scalingMode="fixed", stepped=FALSE), columnAnnotations = amptax$metadata, rowAnnotations = amptax$tax)
```

## Output Files
Complete descriptions of the output files can be found in the [Plots section above](#plots).  To learn how to edit the plots, see the <a href="{{ url_for('show_tutorials') }}">visualization tutorial</a>.

- *rarecurve.html*: rarefaction curve plot
- *rarecurve.txt*: tabular data used to make the rarefaction curve plot
- *samples_being_ignored.txt*: list of samples removed from the analysis
- *pcoa_\*.html*: PCoA plots
- *pcoa_\*.txt*: tabular data used to make the PCoA plots
- *alphadiv.html*: alpha diversity boxplots
- *alphadiv.txt*: tabular data used to make the alpha diversity plots
- *seq_heatmap.html*: heatmap of OTU/sequence variant abundances

## Tools and References
<p>M A, SM K, AS Z, RH K and PH N (2015). "Back to Basics - The Influence of DNA Extraction and Primer Choice on Phylogenetic Analysis of Activated Sludge Communities." <em>PLoS ONE</em>, <b>10</b>(7), pp. e0132783. <a href="http://dx.plos.org/10.1371/journal.pone.0132783" target="_blank" rel="noopener noreferrer">http://dx.plos.org/10.1371/journal.pone.0132783</a>.</p>
<p>Gould J (2018). <em>morpheus: Interactive heat maps using 'morpheus.js' and 'htmlwidgets'</em>. R package version 0.1.1.1, <a href="https://github.com/cmap/morpheus.R" target="_blank" rel="noopener noreferrer">https://github.com/cmap/morpheus.R</a>.</p>
<p>Sievert C, Parmer C, Hocking T, Chamberlain S, Ram K, Corvellec M and Despouy P (2017). <em>plotly: Create Interactive Web Graphics via 'plotly.js'</em>. R package version 4.7.1, <a href="https://CRAN.R-project.org/package=plotly" target="_blank" rel="noopener noreferrer">https://CRAN.R-project.org/package=plotly</a>.</p>
<p>McMurdie PJ and Paulson JN (2016). <em>biomformat: An interface package for the BIOM file format</em>. <a href="https://github.com/joey711/biomformat/" target="_blank" rel="noopener noreferrer">https://github.com/joey711/biomformat/</a>.</p>
